#!/usr/bin/env bash
# shellcheck disable=SC1090

set -eou pipefail

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source "${DIR}/../dotfiles/.lib_sh/echos.sh"

[[ -n ${UNION_DEBUG:-} ]] && bot "Enabling debug mode" && set -x

function usage() {
  cat <<- EOF

  download all public repos from a organization or user

  usage: $0 <name>

EOF
}

function is_user() {
  curl -I -X GET "${API_URL}/users/${NAME}" \
    -H "Authorization: token ${GH_TOKEN}" \
    --compressed | grep Status: | awk '{print $2}'
}

function is_org() {
  curl -I -X GET "${API_URL}/orgs/${NAME}" \
    -H "Authorization: token ${GH_TOKEN}" \
    --compressed | grep Status: | awk '{print $2}'
}

function list_repos() {
  local type="$1"
  local name="$2"
  local page="${3:-1}"

  curl -X GET "${API_URL}/${type}/${name}/repos?per_page=${PER_PAGE}&page=${page}" \
    -H "Authorization: token ${GH_TOKEN}" \
    --compressed
}

function clone_repos() {
  local type="$1"
  local name="$2"
  local dir="${HOME}/src/github.com/${name}"
  mkdir -p "$dir"
  cd "$dir"

  count=$PER_PAGE
  page=1
  while [ "$count" -eq "$PER_PAGE" ]
  do
    repos="$(list_repos "$type" "$name" "$page" | jq '.[].clone_url')"
    count=$(echo "$repos" | wc -l)
    echo "request page $page returned $count"
    if [ "$count" = "$PER_PAGE" ]
    then
      page=$((page + 1))
    fi
    echo "$repos" | xargs -n 1 git clone
  done
}

function main() {
  bot "searching github for $NAME"
  selection="none"

  if [ "$(is_user)" = "200" ]
  then
    selection=1
  fi

  if [ "$(is_org)" = "200" ]
  then
    selection=2
  fi

  case "$selection" in
    1|user)
      action "cloning user repos"
      clone_repos "users" "$NAME"
      ;;
    2|org)
      action "cloning org repos"
      clone_repos "orgs" "$NAME"
      ;;
    *)
      die "I did not find a github account for $NAME"
      ;;
  esac
}

banner

if [ "$#" -lt 1 ]; then usage; die; fi # if no parameters show usage and die

GH_TOKEN="$(head -n 1 $HOME/.github_token)"
API_URL="https://api.github.com"
NAME="$1"
PER_PAGE=100

main "$@"
